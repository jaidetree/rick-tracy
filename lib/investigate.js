"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function investigate(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(Investigator,[null].concat(t)))}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.Investigator=void 0,exports["default"]=investigate;var _babelCore=require("babel-core"),_babelCore2=_interopRequireDefault(_babelCore),_path=require("path"),_path2=_interopRequireDefault(_path),_detectiveCjs=require("detective-cjs"),_detectiveCjs2=_interopRequireDefault(_detectiveCjs),_resolve=require("resolve"),_resolve2=_interopRequireDefault(_resolve),_vinylFile=require("vinyl-file"),_vinylFile2=_interopRequireDefault(_vinylFile),_deferred=require("./deferred"),_deferred2=_interopRequireDefault(_deferred),_stream=require("stream"),Investigator=exports.Investigator=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,{objectMode:!0}));return r.options=Object.assign({ignorePackages:!0},e),r.notes={},r._write=r._write.bind(r),r.on("finish",function(){console.log("Finished!"),r.push(null)}),r}return _inherits(t,e),_createClass(t,[{key:"interrogate",value:function(e){var t=this,r=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=[],o=[],i=this.isNoted(e);return i?n=this.readNotesOn(e):(e.contents=this.roughUp(e),n=this.verify(e,(0,_detectiveCjs2["default"])(e.contents)),this.note(e,n),n.forEach(function(r){o.push(t.trackDown(r).then(function(r){return t.interrogate(r,e.path)}))})),this.push({suspect:e.path,leads:n,source:r}),Promise.all(o)}},{key:"isNoted",value:function(e){return this.notes.hasOwnProperty(e.path)}},{key:"note",value:function(e,t){this.notes[e.path]=t}},{key:"readNotesOn",value:function(e){return this.notes[e.path]}},{key:"roughUp",value:function(e){var t=_babelCore2["default"].transform(e.contents.toString("utf8"),{babelrc:!1,plugins:["transform-es2015-modules-commonjs"],sourceMap:!1});return new Buffer(t.code)}},{key:"trackDown",value:function(e){var t=new _deferred2["default"];return _vinylFile2["default"].read(e,t.callback),t}},{key:"verify",value:function(e,t){var r=_path2["default"].dirname(e.path),n=[];return n=t.map(function(e){return _resolve2["default"].sync(e,{basedir:r,extensions:[".js",".jsx"]})}),this.options.ignorePackages&&(n=n.filter(function(e){return!e.includes("node_modules")})),"function"!=typeof this.options.resolve?n:n.map(this.options.resolve)}},{key:"_read",value:function(){}},{key:"_write",value:function(e,t,r){this.interrogate(e).then(function(){return r()})}}]),t}(_stream.Duplex);