"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var _slicedToArray=function(){function e(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(s){o=!0,i=s}finally{try{!n&&u["return"]&&u["return"]()}finally{if(o)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();Object.defineProperty(exports,"__esModule",{value:!0});var _streamCombiner=require("stream-combiner2"),_streamCombiner2=_interopRequireDefault(_streamCombiner),_concatStream=require("concat-stream"),_concatStream2=_interopRequireDefault(_concatStream),_duplexer=require("duplexer2"),_duplexer2=_interopRequireDefault(_duplexer),_resolve=require("resolve"),_resolve2=_interopRequireDefault(_resolve),_path=require("path"),_path2=_interopRequireDefault(_path),_detectiveCjs=require("detective-cjs"),_detectiveCjs2=_interopRequireDefault(_detectiveCjs),_through=require("through2"),_through2=_interopRequireDefault(_through),_vinylFile=require("vinyl-file"),_vinylFile2=_interopRequireDefault(_vinylFile),_Deferred=require("./Deferred"),_Deferred2=_interopRequireDefault(_Deferred),_stream=require("stream"),babel=require("babel-core"),Investigator=function(e){function r(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,r);var t=_possibleConstructorReturn(this,Object.getPrototypeOf(r).call(this,{objectMode:!0}));return t.options=Object.assign({compileES6Modules:!0,ignorePackages:!0,transforms:[]},e),t.notes={},t.transformer=null,t._write=t._write.bind(t),t.on("finish",function(){t.push(null)}),t}return _inherits(r,e),_createClass(r,[{key:"createTransformer",value:function(){var e=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],r=(0,_through2["default"])(),t=(0,_through2["default"])(),n=(0,_duplexer2["default"])(r,t),o=void 0;return e=e.map(function(e){var r=_slicedToArray(e,2),t=r[0],o=r[1];return"string"==typeof t&&(t=require(_resolve2["default"].sync(t))),t(o).on("error",n.emit.bind(n,"error"))}),o=_streamCombiner2["default"].apply(void 0,_toConsumableArray(e)),r.pipe(o).pipe(t),n}},{key:"interrogate",value:function(e){function r(){o.push({suspect:e.path,leads:i,source:n})}var t=this,n=arguments.length<=1||void 0===arguments[1]?null:arguments[1],o=this,i=[],a=this.isNoted(e),u=new _Deferred2["default"];return a?(i=this.readNotesOn(e),r(),u.resolve()):this.roughUp(e).then(function(n){var o=[];i=t.verify(e,(0,_detectiveCjs2["default"])(n)),t.note(e,i),r(),o=i.map(function(r){return t.trackDown(r).then(function(r){return t.interrogate(r,e.path)})["catch"](function(){})}),u.resolve(Promise.all(o))})["catch"](function(e){return t.emit("error",e)}),u.promise()}},{key:"isNoted",value:function(e){return this.notes.hasOwnProperty(e.path)}},{key:"note",value:function(e,r){this.notes[e.path]=r}},{key:"readNotesOn",value:function(e){return this.notes[e.path]}},{key:"roughUp",value:function(e){var r=this,t=e.contents.toString("utf8"),n=this.options.transforms;if(this.options.compileES6Modules){var o=babel.transform(e.contents.toString("utf8"),{babelrc:!1,presets:["stage-0"],plugins:["transform-react-jsx","transform-es2015-modules-commonjs"],sourceMap:!1});t=o.code}return new Promise(function(e,o){return Array.isArray(n)&&n.length?(r.transformer||(r.transformer=r.createTransformer(n)),r.transformer.on("error",o),r.transformer.pipe((0,_concatStream2["default"])(function(t){r.transformer.removeListener("error",o),r.transformer.unpipe(),e(t)})),void r.transformer.end(t)):void e(t)})}},{key:"trackDown",value:function(e){var r=new _Deferred2["default"];return _vinylFile2["default"].read(e,r.callback),r.promise()}},{key:"transform",value:function(e){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this.options.transforms.push([e,r]),this}},{key:"verify",value:function(e,r){var t=this,n=_path2["default"].dirname(e.path),o=this.options,i=r;return o.filter&&(i=i.filter(o.filter)),o.ignorePackages&&(i=i.filter(function(e){return(e.includes(".js")||e.includes("/"))&&!e.endsWith(".css")&&!e.endsWith(".html")})),this.options.map&&(i=i.map(this.options.map)),i=i.map(function(e){try{return _resolve2["default"].sync(e,{basedir:n,extensions:[".js",".jsx"],packageFilter:t.options.packageFilter})}catch(r){return null}}),i=i.filter(function(e){return!!e}),o.postFilter&&(i=r.filter(o.postFilter)),o.ignorePackages&&(i=i.filter(function(e){return!e.includes("node_modules")})),"function"!=typeof o.map?i:i}},{key:"_read",value:function(){}},{key:"_write",value:function(e,r,t){var n=this;this.interrogate(e).then(function(){t()})["catch"](function(e){n.emit("error",e)})}}]),r}(_stream.Duplex);exports["default"]=Investigator;